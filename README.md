# 基于 LangChain4j + Ollama 的轻量级 ReAct 智能体模板

本项目是针对智能体构建的模板工程，基于 LangChain4j + Ollama，提供**轻量级** ReAct（推理-行动-观察）范式的实现方案，结合工具调用、对话记忆，支持不同交互方式（CLI / HTTP），便于初学者快速构建。

## 模型选择

借由 Ollama 拉取本地模型，示例如下：

```shell
ollama pull deepseek-r1:8b
ollama pull qwen3:8b
```

## 架构设计

项目结合分层架构与领域驱动设计（DDD）。

| 层级      | 包路径      | 核心职责   | 设计特点       |
|---------|----------|--------|------------|
| **接口层** | `api`    | 提供交互入口 | 命令模式、MVC模式 |
| **领域层** | `domain` | 实现业务逻辑 | 领域驱动设计     |

| 领域       | 包路径             | 核心职责                | 设计特点     |
|----------|-----------------|---------------------|----------|
| **智能体域** | `domain.agent`  | 协调流程、推理决策、调用工具、观测结果 | ReAct 范式 |
| **提示词域** | `domain.prompt` | 构建提示词               | 模板方法模式   |
| **工具域**  | `domain.tool`   | 注册、发现、执行工具          | 注册模式     |

## ReAct 范式

智能体基于 ReAct 范式构建，核心是通过‌交替执行**推理（Reasoning）、行动（Acting）和观察（Observation）**的循环流程‌以解决模糊问题。根据模型原生是否支持**工具调用（Function Calling）协议**，项目提供两种实现。

- **手动模式**，可适用于基础模型（如 `deepseek-r1:8b`），协议层由开发者自定义（提示词）
    - **程序**预先定义回答格式（通常 JSON）、工具说明、规则约束等，写于提示词
    - **模型**根据问题输入，进行推理，按照定义格式，输出回答
    - **程序**控制循环流程，包括解析回答、映射工具方法、执行工具并生成观察结果，反馈输入给模型
- **自动模式**，仅适用于进阶模型（如 `qwen3:8b`），协议层由框架与模型约定
    - **框架**（`AiServices`）自动将 `@Tool` 工具转换为模型专用协议格式
    - **模型**根据问题输入，进行推理，返回结构化工具调用请求，而非自由文本
    - **框架**管理循环流程

后文如无特殊说明，则为**手动模式**的说明。

## ReAct 流程

ReAct 流程通过多次"推理-行动-观察"循环（“一次循环”视作“一步”）来完成任务，直到得出最终答案或达到最大步数（`maxSteps`
）为止，整个流程为“一轮”。

在一轮流程中，系统消息首置，由 【角色定位】+【回答格式】+【规则约束】+【可用工具】+【环境信息】 五部分组成， 以 Markdown 格式组织于提示词。

【回答格式】示例如下：

```java
String formatPrompt = """
你必须严格使用 JSON 格式回复，结构如下：

{
  "question": "用户的问题",
  "thought": "你的思考过程",
  "action": [{"tool": "工具名", "参数1": "值1", "参数2": "值2"}],
  "observation": "工具执行后的观察结果",
  "final_answer": "最终答案"
}

""";
```

【规则约束】示例如下：

```java
String rulePrompt = """
1. 必须包含 thought 字段值，描述你的思考过程
2. 如需使用工具，在 action 字段中指定值（支持多个工具）
3. 不要生成 observation 字段值，我会提供工具执行结果
4. 只有在获取所有工具结果后，才提供 final_answer 字段值
5. 文件路径使用绝对路径
6. 多行参数使用 \\n 表示换行
7. 只返回 JSON 对象，不要添加任何额外文本
"""
```

首条用户消息为【用户问题】，后续程序根据回复，按需调用工具，生成【观测结果】，并作为用户消息反馈。

对话历史由 `InMemoryChatMemory` （框架提供）存储于内存，取固定数量的最近消息作为上下文，并由 `MessageWindowChatMemory` （框架提供）的滑动窗口维护。

步数累积达刷新间隔 `refreshInterval` 即清空上下文但保留关键信息。

## 工具管理

| 核心类        | 类名               | 职责                    |
|:-----------|:-----------------|:----------------------|
| **工具注册中心** | `ToolRegistry`   | 扫描 `@Tool` 注解方法，自动注册  |
| **工具包装类**  | `ExecutableTool` | 封装工具规范、目标对象和方法，提供执行接口 |

目前提供的工具仅涉及网页抓取、文件读写、命令行执行等基础操作。

## 启动流程

1. **AI 模型启动**：启动 Ollama
2. **客户端配置**：编辑 `application.properties` 文件，配置相应参数，并按需调整 `config` 中的配置
3. **项目启动**：运行 `Application.java` 主类，启动 Spring Boot 应用
5. **智能体交互**：通过 CLI / HTTP 接口，与智能体交互，令其执行相关操作

## 参考资料

- LangChain4j 文档：https://docs.langchain4j.dev/intro
- LangChain4j 仓库：https://github.com/langchain4j/langchain4j
- Ollama 模型库：https://ollama.com/library
- 《ReAct：在语言模型中协同推理和行动》：https://arxiv.org/abs/2210.03629
